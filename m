Return-Path: <qemu-devel-bounces+lists+qemu-devel=lfdr.de@nongnu.org>
X-Original-To: lists+qemu-devel@lfdr.de
Delivered-To: lists+qemu-devel@lfdr.de
Received: from lists.gnu.org (lists.gnu.org [209.51.188.17])
	by mail.lfdr.de (Postfix) with ESMTPS id 555C47ED1FC
	for <lists+qemu-devel@lfdr.de>; Wed, 15 Nov 2023 21:29:28 +0100 (CET)
Received: from localhost ([::1] helo=lists1p.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.90_1)
	(envelope-from <qemu-devel-bounces@nongnu.org>)
	id 1r3MUY-0001h8-Vn; Wed, 15 Nov 2023 15:28:07 -0500
Received: from eggs.gnu.org ([2001:470:142:3::10])
 by lists.gnu.org with esmtps (TLS1.2:ECDHE_RSA_AES_256_GCM_SHA384:256)
 (Exim 4.90_1) (envelope-from <vr_qemu@t-online.de>)
 id 1r3MUV-0001fB-3R
 for qemu-devel@nongnu.org; Wed, 15 Nov 2023 15:28:03 -0500
Received: from mailout03.t-online.de ([194.25.134.81])
 by eggs.gnu.org with esmtps (TLS1.2:ECDHE_RSA_AES_256_GCM_SHA384:256)
 (Exim 4.90_1) (envelope-from <vr_qemu@t-online.de>)
 id 1r3MUT-0008Sg-4H
 for qemu-devel@nongnu.org; Wed, 15 Nov 2023 15:28:02 -0500
Received: from fwd82.aul.t-online.de (fwd82.aul.t-online.de [10.223.144.108])
 by mailout03.t-online.de (Postfix) with SMTP id 8CF4EC0AF;
 Wed, 15 Nov 2023 21:27:55 +0100 (CET)
Received: from [192.168.211.200] ([93.236.156.187]) by fwd82.t-online.de
 with (TLSv1.3:TLS_AES_256_GCM_SHA384 encrypted)
 esmtp id 1r3MUM-21csIj0; Wed, 15 Nov 2023 21:27:54 +0100
Message-ID: <04ed8955-81eb-4cf1-8a5c-b14eb127831b@t-online.de>
Date: Wed, 15 Nov 2023 21:27:53 +0100
MIME-Version: 1.0
User-Agent: Mozilla Thunderbird
Subject: virtio-sound segmentation fault
Content-Language: en-US
References: <1444ddb7-8a77-4918-997d-c4ed6a6273ee@t-online.de>
To: Manos Pitsidianakis <manos.pitsidianakis@linaro.org>,
 Gerd Hoffmann <kraxel@redhat.com>, "Michael S. Tsirkin" <mst@redhat.com>
Cc: qemu-devel@nongnu.org
From: =?UTF-8?Q?Volker_R=C3=BCmelin?= <vr_qemu@t-online.de>
In-Reply-To: <1444ddb7-8a77-4918-997d-c4ed6a6273ee@t-online.de>
X-Forwarded-Message-Id: <1444ddb7-8a77-4918-997d-c4ed6a6273ee@t-online.de>
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit
X-TOI-EXPURGATEID: 150726::1700080074-04981954-6945F7CD/0/0 CLEAN NORMAL
X-TOI-MSGID: e2f102a3-a179-4adc-9d12-4e679dc84e75
Received-SPF: pass client-ip=194.25.134.81; envelope-from=vr_qemu@t-online.de;
 helo=mailout03.t-online.de
X-Spam_score_int: -18
X-Spam_score: -1.9
X-Spam_bar: -
X-Spam_report: (-1.9 / 5.0 requ) BAYES_00=-1.9, FREEMAIL_FROM=0.001,
 RCVD_IN_DNSWL_NONE=-0.0001, RCVD_IN_MSPIKE_H3=0.001, RCVD_IN_MSPIKE_WL=0.001,
 SPF_HELO_NONE=0.001, SPF_PASS=-0.001,
 T_SCC_BODY_TEXT_LINE=-0.01 autolearn=ham autolearn_force=no
X-Spam_action: no action
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
 <mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <https://lists.nongnu.org/archive/html/qemu-devel>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
 <mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Errors-To: qemu-devel-bounces+lists+qemu-devel=lfdr.de@nongnu.org
Sender: qemu-devel-bounces+lists+qemu-devel=lfdr.de@nongnu.org

Cc: qemu-devel

Hi Manos,

it's easy to trigger a segmentation fault with the virtio-sound device.
The basic problem is that in function virtio_snd_realize() there is no
code in the errror paths to undo the previous steps.

To reproduce the segmentation fault start QEMU with an empty PCIe root
port. The necessary command line options are

-device
pcie-root-port,port=224,chassis=1,id=pcie.1,addr=0x1c,multifunction=on
-audiodev pipewire,id=audio0

Then hotplug a virtio-sound device with the compat monitor. Please note
the missing audiodev argument so that AUD_register_card() in
virtio_snd_realize() fails. It's also necessary to apply your
"virtio-snd: check AUD_register_card return value" patch, otherwise the
device_add command fails immediately with a segmentation fault.

QEMU 8.1.90 monitor - type 'help' for more information
(qemu) device_add virtio-sound,bus=pcie.1
Error: no default audio driver available
Perhaps you wanted to use -audio or set audiodev=audio0?
(qemu) device_add virtio-sound,bus=pcie.1,audiodev=audio0
(qemu)

Now shutdown the guest. Most of the time QEMU will dump core because
there is no qemu_del_vm_change_state_handler() in the
virtio_snd_realize() error path.

Core was generated by `./qemu-system-x86_64 -machine
q35,usb=off,vmport=off,hpet=off,dump-guest-core=o'.
Program terminated with signal SIGSEGV, Segmentation fault.
(gdb) bt
#0  0x00005649d3aa70d2 in object_dynamic_cast_assert
    (obj=obj@entry=0x5649d6da73d0,
typename=typename@entry=0x5649d3d944a5 "device",
file=file@entry=0x5649d3c9b8e0
"/home/ruemelin/rpmbuild/BUILD/qemu-master/include/hw/qdev-core.h",
line=line@entry=77, func=func@entry=0x5649d3e89d45 <__func__.16> "DEVICE")
    at ../qemu-master/qom/object.c:887
#1  0x00005649d3a1521f in DEVICE (obj=0x5649d6da73d0) at
/home/ruemelin/rpmbuild/BUILD/qemu-master/include/hw/qdev-core.h:77
#2  virtio_vmstate_change (opaque=0x5649d6da73d0, running=<optimized
out>, state=<optimized out>)
    at ../qemu-master/hw/virtio/virtio.c:3188
#3  0x00005649d387fdc0 in vm_state_notify (running=running@entry=false,
state=state@entry=RUN_STATE_SHUTDOWN)
    at ../qemu-master/system/runstate.c:381
#4  0x00005649d3876de0 in do_vm_stop (send_stop=false,
state=RUN_STATE_SHUTDOWN) at ../qemu-master/system/cpus.c:270
#5  vm_shutdown () at ../qemu-master/system/cpus.c:288
#6  0x00005649d3880908 in qemu_cleanup (status=status@entry=0) at
../qemu-master/system/runstate.c:857
#7  0x00005649d366dc91 in qemu_default_main () at
../qemu-master/system/main.c:38
#8  0x00007f1bc4e3e24d in __libc_start_main () at /lib64/libc.so.6
#9  0x00005649d366dbba in _start () at ../sysdeps/x86_64/start.S:120

With best regards,
Volker

